<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title th:text="${pageTitle}">사용자 상세 정보</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <th:block layout:fragment="page-title">사용자 상세 정보</th:block>

    <th:block layout:fragment="page-actions">
        <div class="btn-group">
            <button class="btn btn-primary d-flex align-items-center gap-2" 
                    th:onclick="|location.href='@{/user/account/edit/{id}(id=${item.id})}'|">
                <i class="ri-edit-line"></i>
                수정
            </button>
            <button class="btn btn-danger d-flex align-items-center gap-2"
                    onclick="deleteItem()">
                <i class="ri-delete-bin-line"></i>
                삭제
            </button>
            <button class="btn btn-secondary d-flex align-items-center gap-2" 
                    onclick="location.href='/user/account/list?restore=true'">
                <i class="ri-arrow-left-line"></i>
                목록
            </button>
        </div>
    </th:block>

    <div layout:fragment="content">
        <div class="card">
            <div class="card-body p-4">
                <!-- 프로필 섹션 -->
                <div class="d-flex align-items-center mb-4 pb-4 border-bottom">
                    <div class="flex-shrink-0">
                        <div class="avatar-lg bg-light rounded-circle p-3">
                            <i class="ri-user-3-line fs-1 text-primary"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h4 class="mb-1" th:text="${item.username}">사용자명</h4>
                    </div>
                </div>

                <!-- 상세 정보 섹션 -->
                <div class="row g-4">
                    <!-- 계정 상태 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-switch-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">계정상태</label>
                                        <div>
                                            <span th:if="${item.enabled}" class="badge bg-success-subtle text-success">
                                                <i class="ri-checkbox-circle-line align-middle"></i> 활성
                                            </span>
                                            <span th:unless="${item.enabled}" class="badge bg-danger-subtle text-danger">
                                                <i class="ri-close-circle-line align-middle"></i> 비활성
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 직책 정보 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-user-star-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">직책</label>
                                        <p class="mb-0" th:text="${item.position?.name}">직책</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 권한 정보 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="ri-shield-user-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-2">권한</label>
                                        <div>
                                            <span th:each="role : ${item.roles}" 
                                                  class="badge bg-primary-subtle text-primary me-1 mb-1">
                                                <i class="ri-shield-star-line me-1"></i>
                                                <span th:text="${role.name}">권한</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 소속 조직 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="ri-building-4-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-2">소속 조직</label>
                                        <div>
                                            <span th:each="org : ${item.organizations}" 
                                                  class="badge bg-secondary-subtle text-secondary me-1 mb-1">
                                                <i class="ri-building-2-line me-1"></i>
                                                <span th:text="${org.name}">조직</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 기본 정보 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-user-3-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">계정명</label>
                                        <p class="mb-0" th:text="${item.username}">계정명</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-user-heart-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">이름</label>
                                        <p class="mb-0" th:text="${item.realName}">이름</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 연락처 정보 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-mail-send-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">이메일</label>
                                        <p class="mb-0" th:text="${item.email}">이메일</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-cellphone-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">휴대전화</label>
                                        <p class="mb-0" th:text="${item.mobilePhone}">휴대전화</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-phone-fill fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">사무실 전화</label>
                                        <p class="mb-0" th:text="${item.officePhone}">사무실 전화</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 주소 정보 -->
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-map-pin-2-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">우편번호</label>
                                        <p class="mb-0" th:text="${item.postalCode}">우편번호</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="ri-home-4-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-0">주소</label>
                                        <p class="mb-0">
                                            <span th:text="${item.address}">주소</span>
                                            <span th:if="${item.addressDetail}" th:text="${item.addressDetail}">상세주소</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 자기소개 (가로 두칸) -->
                    <div class="col-md-12">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="ri-file-list-3-line fs-4 text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <label class="small text-muted mb-2">자기소개</label>
                                        <p class="mb-0" style="white-space: pre-line" th:text="${item.description}">자기소개</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 감사 정보 (페이지 하단) -->
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="d-flex align-items-center">
                        <i class="ri-fingerprint-line me-1 text-muted"></i>
                        <p class="text-muted small mb-0 copy-to-clipboard" th:text="${item.id}">ID</p>
                    </div>
                    <div class="text-muted small">
                        <span class="me-3">
                            <i class="ri-user-add-line me-1"></i>
                            등록: <span th:text="${item.createdBy}">등록자</span>
                            <span th:if="${item.createdAt != null}" 
                                  th:text="${#temporals.format(item.createdAt, 'yyyy.MM.dd HH:mm')}">등록일시</span>
                        </span>
                        <span>
                            <i class="ri-edit-2-line me-1"></i>
                            수정: <span th:text="${item.updatedBy}">수정자</span>
                            <span th:if="${item.updatedAt != null}" 
                                  th:text="${#temporals.format(item.updatedAt, 'yyyy.MM.dd HH:mm')}">수정일시</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:fragment="brief-content">
        <div class="d-flex align-items-center mb-3">
            <div class="flex-shrink-0">
                <div class="avatar bg-light rounded-circle p-2">
                    <i class="ri-user-3-line fs-4 text-primary"></i>
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h6 class="mb-1" th:text="${item.username}">사용자명</h6>
                <div class="d-flex align-items-center">
                    <p class="text-muted small mb-0 copy-to-clipboard" th:text="${item.id}">ID</p>
                </div>
            </div>
        </div>

        <div class="mb-2">
            <label class="form-label small text-muted">사용여부</label>
            <div>
                <span th:if="${item.enabled}" class="badge bg-success-subtle text-success">
                    <i class="ri-checkbox-circle-line align-middle"></i> 활성
                </span>
                <span th:unless="${item.enabled}" class="badge bg-danger-subtle text-danger">
                    <i class="ri-close-circle-line align-middle"></i> 비활성
                </span>
            </div>
        </div>

        <div class="mb-2">
            <label class="form-label small text-muted">직책</label>
            <p class="mb-1" th:text="${item.position?.name}">직책</p>
        </div>

        <div class="mb-2">
            <label class="form-label small text-muted">권한</label>
            <div>
                <span th:each="role : ${item.roles}" 
                      class="badge bg-primary-subtle text-primary me-1 mb-1">
                    <i class="ri-shield-star-line me-1"></i>
                    <span th:text="${role.name}">권한</span>
                </span>
            </div>
        </div>

        <div class="mb-2">
            <label class="form-label small text-muted">소속 조직</label>
            <div>
                <span th:each="org : ${item.organizations}" 
                      class="badge bg-secondary-subtle text-secondary me-1 mb-1">
                    <i class="ri-building-2-line me-1"></i>
                    <span th:text="${org.name}">조직</span>
                </span>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <!-- 필수 스크립트 로드 -->
        <script th:src="@{/js/components/modal-manager.js}"></script>
        <script th:src="@{/js/components/delete-confirm-modal.js}"></script>

        <script th:inline="javascript">
            let deleteConfirmModal;
            const userId = /*[[${item.id}]]*/ '';  // 전역 변수로 선언

            document.addEventListener('DOMContentLoaded', () => {
                try {
                    // 삭제 확인 모달 초기화
                    deleteConfirmModal = new DeleteConfirmModal().init();

                    // 삭제 버튼 이벤트 핸들러 설정
                    const deleteButton = document.querySelector('.btn-delete');
                    if (deleteButton) {
                        deleteButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            deleteItem();  // userId를 파라미터로 전달하지 않음
                        });
                    }
                } catch (error) {
                    console.error('초기화 중 오류 발생:', error);
                }
            });

            // 삭제 함수
            function deleteItem() {  // 파라미터 제거
                if (!userId) {  // userId 유효성 검사 추가
                    console.error('User ID is not defined');
                    SimpliXUtils.showToast('잘못된 접근입니다.', 'danger');
                    return;
                }

                deleteConfirmModal.show('정말 삭제하시겠습니까?', () => {
                    fetch(`/api/user/account/${userId}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            SimpliXUtils.showToast('삭제되었습니다.', 'success');
                            setTimeout(() => {
                                location.href = '/user/account/list?restore=true';
                            }, 500);
                        } else {
                            throw new Error('삭제 실패');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        SimpliXUtils.showToast('삭제에 실패했습니다.', 'danger');
                    });
                });
            }
        </script>
    </th:block>
</body>
</html> 