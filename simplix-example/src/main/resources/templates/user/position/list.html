<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">


<head>
    <title>직급 목록</title>
</head>

<body>
    <th:block layout:fragment="page-title">직급 관리</th:block>

    <th:block layout:fragment="page-actions">
        <button class="btn btn-primary d-flex align-items-center gap-2" onclick="location.href='/user/position/create'">
            <i class="ri-add-line"></i>
            신규 등록
        </button>
    </th:block>

    <div layout:fragment="content">
        <div class="card">
            <div class="card-header bg-white">
                <form id="searchForm" class="row g-3 align-items-center">
                    <div class="col-12 col-sm-6 col-md-auto">
                        <input type="text" class="form-control" id="searchId" placeholder="ID" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-auto">
                        <input type="text" class="form-control" id="searchName" placeholder="직급명" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-auto">
                        <input type="text" class="form-control" id="searchDescription" placeholder="설명" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-auto ms-md-auto">
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary d-flex align-items-center gap-2" id="btnSearch">
                                <i class="ri-search-line"></i>
                                검색
                            </button>
                            <button type="button" class="btn btn-secondary d-flex align-items-center gap-2" id="btnReset">
                                <i class="ri-refresh-line"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="card-body">
                <div id="positionGrid" class="ag-theme-alpine w-100"></div>
            </div>
        </div>

        <!-- 배치 수정 모달 템플릿 -->
        <template id="batchEditFormTemplate">
            <form id="batchEditForm">
                <div class="d-flex flex-column gap-3">
                    <!-- 순서 변경 섹션 -->
                    <div class="border rounded">
                        <div class="section-header d-flex align-items-center gap-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input section-toggle" type="checkbox" 
                                       data-target="itemOrderSection" id="itemOrderToggle">
                            </div>
                            <span class="section-header-text">순서 변경</span>
                        </div>
                        <div class="dropdown-item-form" id="itemOrderSection">
                            <input type="number" class="form-control form-control-sm" name="itemOrder" disabled />
                        </div>
                    </div>
                </div>
            </form>
        </template>
    </div>

    <th:block layout:fragment="script">
        <!-- 공통 컴포넌트 -->
        <script th:src="@{/js/components/modal-manager.js}"></script>
        <script th:src="@{/js/components/grid-manager.js}"></script>
        
        <!-- 모달 컴포넌트 -->
        <script th:src="@{/js/components/batch-edit-modal.js}"></script>
        <script th:src="@{/js/components/delete-confirm-modal.js}"></script>
        <script th:src="@{/js/components/compare-modal.js}"></script>

        <script th:inline="javascript">
            let gridManager;
            let batchEditModal;
            let deleteConfirmModal;
            let modalCompare;

            document.addEventListener('DOMContentLoaded', async () => {
                gridManager = new GridManager({
                    gridElementId: 'positionGrid',
                    searchFormId: 'searchForm',
                    searchUrl: '/api/user/position/search',
                    storageKey: 'userPositionListState',
                    pageSize: 10,
                    gridOptions: {
                        rowSelection: 'multiple',
                        defaultColDef: {
                            suppressHeaderMenuButton: true,
                            headerClass: 'ag-header-center',
                            flex: 1,
                            cellClass: 'ag-center-cell',
                            resizable: true,
                            minWidth: 50
                        }
                    },
                    columnDefs: [
                        { field: 'id', headerName: 'ID', hide: true },
                        { 
                            field: 'name', 
                            headerName: '직급명',
                            sortable: true,
                            flex: 2
                        },
                        { 
                            field: 'description', 
                            headerName: '설명',
                            flex: 2
                        },
                        { 
                            field: 'itemOrder', 
                            headerName: '순서',
                            width: 80
                        },
                        { 
                            field: 'createdAt', 
                            headerName: '등록일시',
                            sortable: true,
                            sort: 'desc',
                            cellRenderer: params => {
                                if (!params.value) return '';
                                const date = new Date(params.value);
                                return date.toLocaleDateString();
                            }
                        },
                        {
                            headerName: '관리',
                            width: 120,
                            cellRenderer: params => {
                                if (!params.data) return '';
                                return `<div class="btn-group">
                                    <button class="btn btn-sm btn-outline-info" onclick="viewItem('${params.data.id}')">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editItem('${params.data.id}')">
                                        <i class="ri-edit-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${params.data.id}')">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>`;
                            }
                        }
                    ],
                    searchFields: {
                        'searchId': { field: 'id', operator: 'equals' },
                        'searchName': { field: 'name', operator: 'contains' },
                        'searchDescription': { field: 'description', operator: 'contains' }
                    },
                    customButtons: [
                        {
                            id: 'btnBatchEdit',
                            className: 'btn btn-primary btn-xs d-flex align-items-center gap-1',
                            disabled: true,
                            title: '일괄 수정',
                            icon: 'ri-edit-line',
                            text: '수정',
                            onclick: () => showBatchEditModal()
                        },
                        {
                            id: 'btnDeleteSelected',
                            className: 'btn btn-danger btn-xs d-flex align-items-center gap-1',
                            disabled: true,
                            title: '선택 삭제',
                            icon: 'ri-delete-bin-line',
                            text: '삭제',
                            onclick: () => batchDelete()
                        },
                        {
                            id: 'btnCompareSelected',
                            className: 'btn btn-secondary btn-xs d-flex align-items-center gap-1',
                            disabled: true,
                            title: '비교',
                            icon: 'ri-file-list-2-line',
                            text: '비교',
                            onclick: () => compareSelected()
                        }
                    ],
                    onSelectionChanged: (selectedRows) => {
                        const editBtn = document.getElementById('btnBatchEdit');
                        const deleteBtn = document.getElementById('btnDeleteSelected');
                        const compareBtn = document.getElementById('btnCompareSelected');
                        
                        if (editBtn) editBtn.disabled = selectedRows.length === 0;
                        if (deleteBtn) deleteBtn.disabled = selectedRows.length === 0;
                        if (compareBtn) compareBtn.disabled = selectedRows.length < 2;
                        
                        gridManager.updateSelectedCount();
                    }
                });

                deleteConfirmModal = new DeleteConfirmModal('deleteConfirmModal', { useConfirmCode: true }).init();
                
                batchEditModal = new BatchEditModal({
                    modalId: 'batchEditModal',
                    templateId: 'batchEditFormTemplate',
                    onSave: async (requestData) => {
                        const response = await fetch('/api/user/position/batch', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        if (!response.ok) throw new Error('Update failed');
                    }
                }).init();
                
                modalCompare = new CompareModalManager({
                    modalId: 'compareModal',
                    itemMinWidth: 450,
                    maxWidthRatio: 0.9,
                    maxHeightRatio: 0.8,
                    getDetailUrl: (item) => `/user/position/brief/${item.id}`
                }).init();
            });

            // CRUD 함수들
            function viewItem(id) {
                location.href = `/user/position/detail/${id}`;
            }

            function editItem(id) {
                location.href = `/user/position/edit/${id}`;
            }

            function deleteItem(id) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    fetch(`/api/user/position/${id}`, { method: 'DELETE' })
                        .then(response => {
                            if (response.ok) {
                                SimpliXUtils.showToast('삭제되었습니다.', 'success');
                                gridManager.refreshGrid();
                            }
                        });
                }
            }

            function showBatchEditModal() {
                const selectedCount = gridManager.updateSelectedCount();
                batchEditModal.show(selectedCount);
            }

            function batchDelete() {
                const selectedRows = window.gridApi.getSelectedRows();
                if (selectedRows.length === 0) return;

                deleteConfirmModal.show(
                    `여러건의 데이터가 동시에 삭제됩니다. 정말 삭제하시겠습니까?`,
                    () => {
                        const ids = selectedRows.map(row => row.id);
                        const queryString = ids.map(id => `ids=${id}`).join('&');
                        
                        fetch(`/api/user/position/batch?${queryString}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (response.ok) {
                                SimpliXUtils.showToast('삭제되었습니다.', 'success');
                                window.gridApi.refreshInfiniteCache();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            SimpliXUtils.showToast('삭제에 실패했습니다.', 'danger');
                        });
                    },
                    selectedRows.length
                );
            }

            async function compareSelected() {
                if (!modalCompare) {
                    console.error('CompareModalManager is not initialized');
                    return;
                }
                const selectedRows = window.gridApi.getSelectedRows();
                if (selectedRows.length < 2) {
                    SimpliXUtils.showToast('2개 이상의 항목을 선택해주세요.', 'warning');
                    return;
                }
                await modalCompare.compare(selectedRows);
            }
        </script>
    </th:block>
</body>
</html> 