<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.simplecore.simplix.demo.domain.common.user.mapper.UserOrganizationTreeMapper">
    
    <!-- Common SQL fragments -->
    <sql id="selectColumns">
        o.id,
        o.name,
        o.org_type as orgType,
        o.parent_id as parentId,
        o.description,
        o.item_order as itemOrder,
        o.created_at as createdAt
    </sql>

    <!-- DB별 문자열 연결 함수 -->
    <sql id="concatPath">
        <choose>
            <when test="_databaseId == 'oracle'">p.path || ' > ' || c.name</when>
            <when test="_databaseId == 'mssql'">p.path + ' > ' + c.name</when>
            <otherwise>CONCAT(p.path, ' > ', c.name)</otherwise>
        </choose>
    </sql>

    <!-- DB별 문자열 타입 캐스팅 -->
    <sql id="castString">
        <choose>
            <when test="_databaseId == 'oracle'">VARCHAR2(1000)</when>
            <when test="_databaseId == 'mssql'">NVARCHAR(1000)</when>
            <otherwise>VARCHAR(1000)</otherwise>
        </choose>
    </sql>

    <!-- Tree query with optional starting point -->
    <select id="organizationTree" resultType="dev.simplecore.simplix.demo.web.common.user.dto.UserOrganizationDTOs$UserOrganizationTreeDTO">
        WITH RECURSIVE org_tree (id, name, orgType, parentId, description, itemOrder, createdAt, path, level) AS (
            /* Base query */
            SELECT 
                o.id,
                o.name,
                o.org_type as orgType,
                o.parent_id as parentId,
                o.description,
                o.item_order as itemOrder,
                o.created_at as createdAt,
                CAST(o.name AS <include refid="castString"/>) as path,
                1 as level
            FROM user_organization o
            WHERE 
                <choose>
                    <when test="orgId != null">o.id = #{orgId}</when>
                    <otherwise>o.parent_id IS NULL</otherwise>
                </choose>

            UNION ALL

            /* Recursive query */
            SELECT 
                c.id,
                c.name,
                c.org_type as orgType,
                c.parent_id as parentId,
                c.description,
                c.item_order as itemOrder,
                c.created_at as createdAt,
                CONCAT(p.path, ' > ', c.name) as path,
                p.level + 1
            FROM org_tree p
            INNER JOIN user_organization c ON c.parent_id = p.id
        )
        SELECT 
            t.id,
            t.name,
            t.orgType,
            t.parentId,
            t.description,
            t.itemOrder,
            t.createdAt,
            t.path,
            t.level
        FROM org_tree t
        ORDER BY t.level, t.itemOrder
    </select>

    <!-- SubTree query -->
    <select id="organizationSubTree" resultType="dev.simplecore.simplix.demo.web.common.user.dto.UserOrganizationDTOs$UserOrganizationTreeDTO">
        WITH RECURSIVE org_tree (id, name, orgType, parentId, description, itemOrder, createdAt, path, level) AS (
            /* Base query - start from specified node */
            SELECT 
                o.id,
                o.name,
                o.org_type as orgType,
                o.parent_id as parentId,
                o.description,
                o.item_order as itemOrder,
                o.created_at as createdAt,
                CAST(o.name AS <include refid="castString"/>) as path,
                1 as level
            FROM user_organization o
            WHERE o.id = #{orgId}

            UNION ALL

            /* Recursive query - get children */
            SELECT 
                c.id,
                c.name,
                c.org_type as orgType,
                c.parent_id as parentId,
                c.description,
                c.item_order as itemOrder,
                c.created_at as createdAt,
                CONCAT(p.path, ' > ', c.name) as path,
                p.level + 1
            FROM org_tree p
            INNER JOIN user_organization c ON c.parent_id = p.id
        )
        SELECT 
            t.id,
            t.name,
            t.orgType,
            t.parentId,
            t.description,
            t.itemOrder,
            t.createdAt,
            t.path,
            t.level,
            p.id as "parent.id",
            p.name as "parent.name",
            p.org_type as "parent.orgType",
            p.description as "parent.description"
        FROM org_tree t
        LEFT JOIN user_organization p ON t.parentId = p.id
        ORDER BY t.level, t.itemOrder
    </select>

    <!-- Children IDs -->
    <select id="findAllChildrenIds" resultType="string">
        WITH RECURSIVE org_tree (id) AS (
            /* Base query */
            SELECT id
            FROM user_organization 
            WHERE id = #{orgId}

            UNION ALL

            /* Recursive query */
            SELECT u.id
            FROM user_organization u
            INNER JOIN org_tree t ON u.parent_id = t.id
        )
        SELECT id FROM org_tree WHERE id != #{orgId}
    </select>

    <!-- Parent IDs -->
    <select id="findAllParentIds" resultType="string">
        WITH RECURSIVE org_tree (id, parent_id) AS (
            /* Base query */
            SELECT id, parent_id 
            FROM user_organization 
            WHERE id = #{orgId}

            UNION ALL

            /* Recursive query */
            SELECT u.id, u.parent_id
            FROM user_organization u
            INNER JOIN org_tree t ON u.id = t.parent_id
        )
        SELECT id FROM org_tree WHERE id != #{orgId}
    </select>

    <!-- Direct children -->
    <select id="findDirectChildren" resultType="dev.simplecore.simplix.demo.web.common.user.dto.UserOrganizationDTOs$UserOrganizationMyBatisDTO">
        SELECT 
            <include refid="selectColumns"/>,
            p.id as "parent.id",
            p.name as "parent.name",
            p.org_type as "parent.orgType",
            p.description as "parent.description"
        FROM user_organization o
        LEFT JOIN user_organization p ON o.parent_id = p.id
        WHERE o.parent_id = #{orgId}
        ORDER BY o.item_order
    </select>

    <!-- Direct parent -->
    <select id="findDirectParent" resultType="dev.simplecore.simplix.demo.web.common.user.dto.UserOrganizationDTOs$UserOrganizationMyBatisDTO">
        SELECT 
            p.*,
            pp.id as "parent.id",
            pp.name as "parent.name",
            pp.org_type as "parent.orgType",
            pp.description as "parent.description"
        FROM user_organization o
        INNER JOIN user_organization p ON o.parent_id = p.id
        LEFT JOIN user_organization pp ON p.parent_id = pp.id
        WHERE o.id = #{orgId}
    </select>
</mapper> 