# Default configuration for AccessCore Events Module
# This file provides default settings for all event publishing strategies
# Copy these settings to your application.yml and customize as needed

accesscore:
  events:
    # Event publishing mode
    # Options: local, redis, kafka, rabbit
    # Default: local (single JVM)
    mode: ${EVENT_MODE:local}

    # Enable event metadata enrichment
    # Adds instanceId, publisherMode, and timestamps
    enrich-metadata: true

    # Make events persistent by default
    persistent-by-default: false

    # Default async mode for publishing
    async-by-default: true

    # Instance ID for event tracking
    instance-id: ${INSTANCE_ID:#{T(java.util.UUID).randomUUID().toString()}}

    # ========================================
    # Local Strategy Configuration
    # ========================================
    local:
      # No additional configuration needed
      # Uses Spring ApplicationEventPublisher

    # ========================================
    # Redis Strategy Configuration
    # ========================================
    redis:
      # Redis channel prefix for pub/sub
      channel-prefix: ${REDIS_CHANNEL_PREFIX:simplix:events:}

      # Enable persistent storage alongside pub/sub
      persistent:
        enabled: ${REDIS_PERSISTENT_ENABLED:false}
        ttl: ${REDIS_EVENT_TTL:86400}  # 24 hours in seconds

      # Batch processing settings
      batch:
        enabled: false
        size: 100
        flush-interval: 5000  # milliseconds

    # ========================================
    # Kafka Strategy Configuration
    # ========================================
    kafka:
      # Topic configuration
      topic-prefix: ${KAFKA_TOPIC_PREFIX:simplix-events}
      default-topic: ${KAFKA_DEFAULT_TOPIC:domain-events}

      # Producer configuration
      producer:
        # Acknowledgment level
        # Options: 0 (none), 1 (leader), -1/all (all replicas)
        acks: ${KAFKA_ACKS:1}

        # Retry configuration
        retries: ${KAFKA_RETRIES:3}
        retry-backoff-ms: ${KAFKA_RETRY_BACKOFF:100}

        # Batching configuration
        batch-size: ${KAFKA_BATCH_SIZE:16384}
        linger-ms: ${KAFKA_LINGER_MS:10}
        buffer-memory: ${KAFKA_BUFFER_MEMORY:33554432}

        # Compression
        compression-type: ${KAFKA_COMPRESSION:snappy}

      # Consumer configuration (if needed)
      consumer:
        group-id: ${KAFKA_CONSUMER_GROUP:simplix-events-consumer}
        auto-offset-reset: ${KAFKA_AUTO_OFFSET_RESET:earliest}
        enable-auto-commit: ${KAFKA_AUTO_COMMIT:true}

    # ========================================
    # RabbitMQ Strategy Configuration
    # ========================================
    rabbit:
      # Exchange configuration
      exchange: ${RABBIT_EXCHANGE:simplix.events}
      exchange-type: ${RABBIT_EXCHANGE_TYPE:topic}
      durable-exchange: true
      auto-delete-exchange: false

      # Queue configuration
      queue: ${RABBIT_QUEUE:simplix.events.queue}
      durable-queue: true
      exclusive-queue: false
      auto-delete-queue: false

      # Routing configuration
      routing-key-prefix: ${RABBIT_ROUTING_PREFIX:event.}

      # Message properties
      ttl: ${RABBIT_MESSAGE_TTL:86400000}  # 24 hours in milliseconds
      message-converter: json

      # Retry configuration
      max-retries: ${RABBIT_MAX_RETRIES:3}
      retry-delay: ${RABBIT_RETRY_DELAY:1000}  # milliseconds
      retry-multiplier: 2.0
      max-retry-delay: 30000  # 30 seconds

      # Dead Letter Queue configuration
      dlq:
        enabled: ${RABBIT_DLQ_ENABLED:true}
        exchange: ${RABBIT_DLQ_EXCHANGE:simplix.events.dlq}
        queue: ${RABBIT_DLQ_QUEUE:simplix.events.dlq.queue}
        routing-key: ${RABBIT_DLQ_ROUTING_KEY:dlq.#}
        ttl: ${RABBIT_DLQ_TTL:604800000}  # 7 days

      # Connection pool settings
      connection:
        timeout: ${RABBIT_CONNECTION_TIMEOUT:30000}
        requested-heartbeat: ${RABBIT_HEARTBEAT:60}

    # ========================================
    # Monitoring & Metrics Configuration
    # ========================================
    monitoring:
      # Enable metrics collection
      metrics-enabled: ${EVENTS_METRICS_ENABLED:true}

      # Health check configuration
      health-check:
        enabled: ${EVENTS_HEALTH_CHECK_ENABLED:true}
        interval: 30000  # milliseconds

      # Event statistics
      statistics:
        enabled: true
        window-size: 60  # seconds

# ========================================
# Spring Boot Configuration for Event Infrastructure
# ========================================

spring:
  # Redis configuration (when using Redis strategy)
  # Using Spring Boot 3.x configuration structure
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: ${REDIS_TIMEOUT:2000ms}
      connect-timeout: ${REDIS_CONNECT_TIMEOUT:10s}
      client-name: ${REDIS_CLIENT_NAME:simplix-events}
      # Connection pool configuration using Lettuce (default in Spring Boot 3.x)
      lettuce:
        pool:
          enabled: true
          max-active: ${REDIS_POOL_MAX_ACTIVE:8}
          max-idle: ${REDIS_POOL_MAX_IDLE:8}
          min-idle: ${REDIS_POOL_MIN_IDLE:0}
          max-wait: ${REDIS_POOL_MAX_WAIT:-1ms}
          time-between-eviction-runs: ${REDIS_POOL_EVICTION_RUNS:60s}
        shutdown-timeout: ${REDIS_SHUTDOWN_TIMEOUT:100ms}
      # SSL configuration (if needed)
      ssl:
        enabled: ${REDIS_SSL_ENABLED:false}
      # Sentinel configuration (for high availability)
      sentinel:
        master: ${REDIS_SENTINEL_MASTER:}
        nodes: ${REDIS_SENTINEL_NODES:}
        password: ${REDIS_SENTINEL_PASSWORD:}
      # Cluster configuration (for Redis Cluster)
      cluster:
        nodes: ${REDIS_CLUSTER_NODES:}
        max-redirects: ${REDIS_CLUSTER_MAX_REDIRECTS:3}

  # Kafka configuration (when using Kafka strategy)
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring.json.add.type.headers: false
    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "dev.simplecore.simplix.event"

  # RabbitMQ configuration (when using RabbitMQ strategy)
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}
    virtual-host: ${RABBITMQ_VHOST:/}
    connection-timeout: ${RABBITMQ_CONNECTION_TIMEOUT:30000}
    cache:
      channel:
        size: ${RABBITMQ_CHANNEL_CACHE_SIZE:25}
        checkout-timeout: ${RABBITMQ_CHANNEL_CHECKOUT_TIMEOUT:5000}
      connection:
        mode: ${RABBITMQ_CONNECTION_MODE:channel}
        size: ${RABBITMQ_CONNECTION_CACHE_SIZE:1}

# ========================================
# Management & Actuator Configuration
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info
  endpoint:
    health:
      show-details: when-authorized
  health:
    # Disable specific health indicators if not using
    redis:
      enabled: ${REDIS_HEALTH_ENABLED:false}
    rabbit:
      enabled: ${RABBIT_HEALTH_ENABLED:false}
  metrics:
    tags:
      application: ${spring.application.name:simplix}
      module: events
    distribution:
      percentiles-histogram:
        http.server.requests: true
        events.publish.duration: true
    enable:
      jvm: true
      process: true
      system: true

# ========================================
# Logging Configuration
# ========================================
logging:
  level:
    dev.simplecore.simplix.event: ${EVENTS_LOG_LEVEL:INFO}
    org.springframework.amqp: ${AMQP_LOG_LEVEL:WARN}
    org.springframework.data.redis: ${REDIS_LOG_LEVEL:WARN}
    org.apache.kafka: ${KAFKA_LOG_LEVEL:WARN}
    org.springframework.kafka: ${SPRING_KAFKA_LOG_LEVEL:WARN}